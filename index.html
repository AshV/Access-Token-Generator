<!DOCTYPE html>
<html>
<head>
    <title>Dynamics 365 Access Token Generator Online</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/adal.min.js"></script>
    <script type="text/javascript">

        "use strict";

        //Set these variables to match your environment
        var organizationURI = "https://efrig.crm8.dynamics.com"; //The URL to connect to CRM (online)
        var tenant = "common"; // "efrig.onmicrosoft.com"; //The name of the Azure AD organization you use
        var clientId = "13950f0e-6bb3-4e2f-8ddb-b923302c4338"; //The ClientId you got when you registered the application
        var pageUrl = "https://ashishvishwakarma.com/Access-Token-Generator/"; //The URL of this page in your development environment when debugging.

        var user, authContext, message, errorMessage, loginButton, logoutButton, getAccountsButton, accountsTable, accountsTableBody;

        //Configuration data for AuthenticationContext
        var endpoints = {
            orgUri: organizationURI
        };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage', // enable this for IE, as sessionStorage does not work for localhost.
        };

        document.onreadystatechange = function () {
            if (document.readyState == "complete") {
                loginButton = document.getElementById("login");
                logoutButton = document.getElementById("logout");
                getAccountsButton = document.getElementById("getAccounts");

                loginButton.addEventListener("click", login);
                logoutButton.addEventListener("click", logout);
                getAccountsButton.addEventListener("click", getAccounts);

                //call authentication function
                authenticate();

                if (user) {
                    loginButton.style.display = "none";
                    logoutButton.style.display = "block";
                    getAccountsButton.style.display = "block";

                    var helloMessage = document.createElement("p");
                    helloMessage.textContent = "Hello " + user.profile.name;
                    message.appendChild(helloMessage)

                }
                else {
                    loginButton.style.display = "block";
                    logoutButton.style.display = "none";
                    getAccountsButton.style.display = "none";
                }

            }
        }

        // Function that manages authentication
        function authenticate() {
            //OAuth context
            authContext = new AuthenticationContext(config);

            // Check For & Handle Redirect From AAD After Login
            var isCallback = authContext.isCallback(window.location.hash);
            if (isCallback) {
                authContext.handleWindowCallback();
            }
            var loginError = authContext.getLoginError();

            if (isCallback && !loginError) {
                window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
            }
            else {
                errorMessage.textContent = loginError;
            }
            user = authContext.getCachedUser();

        }

        //function that logs in the user
        function login() {
            authContext.login();
        }
        //function that logs out the user
        function logout() {
            authContext.logOut();
            accountsTable.style.display = "none";
            accountsTableBody.innerHTML = "";
        }

        //function that initiates retrieval of accounts
        function getAccounts() {
            authContext.acquireToken(organizationURI, function retrieveAccounts(error, token) {
                // Handle ADAL Errors.
                if (error || !token) {
                    errorMessage.textContent = 'ADAL error occurred: ' + error;
                    return;
                }

                alert(token);
                console.log(token);
            });
        }

    </script>
</head>
<body>
    <div class="row">
        <div class="column">
            <center>
                <br />
                <br />
                <h1>Dynamics 365 Access Token Generator</h1>
                <h5>Î²eta version</h5>
                <br />
                <br />
                <br />
                <br />
                <br />
                <button id="login">Connect to My Organization</button>
                <button id="getAccounts" style="display:none;">Generate Access Token for My Organization</button>
            </center>
        </div>
    </div>
    <button id="logout" style="display:none;">Disconnect from Organization</button>

    <div id="errorMessage"></div>
    <div id="message"></div>

    <script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-88171590-1', 'auto'); ga('send', 'pageview');</script>
</body>
</html>