<!DOCTYPE html>
<html>
<head>
    <title>Dynamics 365 Access Token Generator Online</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/adal.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.11.2/build/css/alertify.min.css" />
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.11.2/build/alertify.min.js"></script>
    <script type="text/javascript">

        "use strict";

        //Set these variables to match your environment
        var organizationURI = "https://efrig.crm8.dynamics.com"; //The URL to connect to CRM (online)
        var tenant = "common"; // "efrig.onmicrosoft.com"; //The name of the Azure AD organization you use
        var clientId = "13950f0e-6bb3-4e2f-8ddb-b923302c4338"; //The ClientId you got when you registered the application
        var pageUrl = "https://ashishvishwakarma.com/Access-Token-Generator/AdalSPA.html"; //The URL of this page in your development environment when debugging.

        var user, authContext, message, errorMessage, loginButton, logoutButton, getAccountsButton, accountsTable, accountsTableBody;

        //Configuration data for AuthenticationContext
        var endpoints = {
            orgUri: organizationURI
        };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage', // enable this for IE, as sessionStorage does not work for localhost.
        };

        document.onreadystatechange = function () {
            if (document.readyState == "complete") {

                //Set DOM elements referenced by scripts
                message = document.getElementById("message");
                errorMessage = document.getElementById("errorMessage");
                loginButton = document.getElementById("login");
                logoutButton = document.getElementById("logout");
                getAccountsButton = document.getElementById("getAccounts");
                accountsTable = document.getElementById("accountsTable");
                accountsTableBody = document.getElementById("accountsTableBody");

                //Event handlers on DOM elements
                loginButton.addEventListener("click", login);
                logoutButton.addEventListener("click", logout);
                getAccountsButton.addEventListener("click", getAccounts);

                //call authentication function
                authenticate();

                if (user) {
                    loginButton.style.display = "none";
                    logoutButton.style.display = "block";
                    getAccountsButton.style.display = "block";
                    logoutButton.innerHTML = "Disconnect from " + user.profile.name;
                    //   var helloMessage = document.createElement("p");
                    // helloMessage.textContent = "Hello " + user.profile.name;
                    //message.appendChild(helloMessage)

                }
                else {
                    loginButton.style.display = "block";
                    logoutButton.style.display = "none";
                    getAccountsButton.style.display = "none";
                }

            }
        }

        // Function that manages authentication
        function authenticate() {
            //OAuth context
            authContext = new AuthenticationContext(config);

            // Check For & Handle Redirect From AAD After Login
            var isCallback = authContext.isCallback(window.location.hash);
            if (isCallback) {
                authContext.handleWindowCallback();
            }
            var loginError = authContext.getLoginError();

            if (isCallback && !loginError) {
                window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
            }
            else {
                errorMessage.textContent = loginError;
            }
            user = authContext.getCachedUser();

        }

        //function that logs in the user
        function login() {
            authContext.login();
            alertify.success("Logged In!");
        }
        //function that logs out the user
        function logout() {
            authContext.logOut();
            alertify.success("Logged Out!");
        }

        //function that initiates retrieval of accounts
        function getAccounts() {
            authContext.acquireToken(organizationURI, retrieveAccounts)
            document.querySelector("#tokenContainer").style.display = "block";
        }

        //Function that actually retrieves the accounts
        function retrieveAccounts(error, token) {
            // Handle ADAL Errors.
            if (error || !token) {
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }
            getAccountsButton.style.display = "none";
            console.log(token);
            document.querySelector("#tokenContainer").value = token;
            document.querySelector("#copyToClipboard").style.display = "block";

            alertify.success("Access Token generated!");
        }

        function copiedToCliboard() {
            alertify.success("Access Token copied to clipboard!");
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI';
        }

        table {
            border-collapse: collapse;
        }

        td, th {
            border: 1px solid black;
        }

        #errorMessage {
            color: red;
        }

        #message {
            color: green;
        }
    </style>
</head>
<body>
    <div class="row">
        <div class="column">
            <center>
                <br />
                <br />
                <h1>Dynamics 365 Access Token Generator</h1>
                <h5>Î²eta version</h5>
                <br />
                <br />
                <br />
                <br />
                <br />
                <button id="login">Connect to My Organization</button>
                <div class="column column-75">
                    <textarea id="tokenContainer" style="display:none;"></textarea>
                </div>
                <button id="getAccounts" style="display:none;">Generate Access Token for My Organization</button>
                <button data-clipboard-target="#tokenContainer" class="copyToClipboard" onclick="copiedToCliboard()" id="copyToClipboard" style="display:none;">Copy To Clipboard</button>
                <button id="logout" style="display:none;">Logout</button>
            </center>
        </div>
    </div>

    <div id="errorMessage"></div>
    <div id="message"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script>
        new ClipboardJS('.copyToClipboard');
    </script>
</body>
</html>